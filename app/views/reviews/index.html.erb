<% # app/views/reviews/index.html.erb %>

<h2><%= @shop.name %>レビュー</h2>

<div class="mt-1">
  <small class="text-muted">
    <% if @is_searching %>
      <div>
        検索結果: <b><%= @reviews.count %>件</b>
      </div>
    <% else %>
      <div>
        総レビュー数: <b><%= @public_reviews.count %>件</b>
      </div>
      <div>
        平均評価: <b><%= @public_reviews.average(:score)&.round(1) || 0 %></b>
      </div>
    <% end %>
  </small>
</div>

<%# グラフ表示（検索していない場合のみ） %>
<% unless @is_searching %>
  <div class="card">
    <div class="card-body">
      <div>
        <%= line_chart(
          @monthly_data[0][:data],
          ytitle: "総レビュー数",
          messages: {empty: "データがありません"},
          thousands: ",",
          suffix: "件",
          min: 0,
          colors: ["#76B852"],
          curve: true,
          library: {
            scales: {
              x: {
                display: false
              },
              y: {
                beginAtZero: true
              }
            },
            elements: {
              line: {
                tension: 0.4
              }
            },
            plugins: {
              title: {
                display: false,
                text: '総レビュー数推移'
              }
            },
            fill: {
              target: 'origin',
              above: 'rgba(118, 184, 82, 0.2)'
            }
          }
        ) %>
      </div>

      <div>
        <%= column_chart(
          @monthly_data[1][:data],
          ytitle: "月別レビュー数",
          messages: {empty: "データがありません"},
          thousands: ",",
          suffix: "件",
          min: 0,
          colors: ["#4BC0C0"],
          library: {
            scales: {
              y: {
                beginAtZero: true
              }
            },
            plugins: {
              title: {
                display: false,
                text: '月別レビュー数'
              }
            }
          }
        ) %>
      </div>
    </div>
  </div>
<% end %>

<%# 検索フォーム %>
<div class="card mt-3 mb-4">
  <div class="card-body">
    <%= form_with(url: shop_reviews_path(@shop), method: :get, local: true, class: 'row g-3') do |f| %>
      <div class="col-md-4">
        <%= f.label :score, '評価', class: 'form-label' %>
        <%= f.select :score,
          options_for_select(
            [['すべて', '']] + (1..5).map { |n| ["★#{n}", n] },
            params[:score]
          ),
          {},
          class: 'form-select'
        %>
      </div>

      <div class="col-md-4">
        <%= f.label :month, '月', class: 'form-label' %>
        <%= f.select :month,
          options_for_select(
            [['すべて', '']] + @available_months.map { |date| [date.strftime('%Y年%m月'), date.strftime('%Y-%m-01')] },
            params[:month]
          ),
          {},
          class: 'form-select'
        %>
      </div>

      <div class="col-md-4 d-flex align-items-end">
        <%= f.submit '検索', class: 'btn btn-primary me-2' %>
        <%= link_to 'リセット', shop_reviews_path(@shop), class: 'btn btn-secondary' %>
      </div>
    <% end %>
  </div>
</div>

<!-- レビュー一覧部分 -->
<table class="table table-hover mt-4">
  <thead>
    <tr>
      <th>評価</th>
      <th>コメント</th>
      <th>投稿日</th>
      <th>カウント</th>
    </tr>
  </thead>
  <tbody>
    <% @paginated_reviews.each do |review| %>
      <tr>
        <td>
          <span class="review-stars"><%= "★" * review.score %></span>
          <span class="review-score">(<%= review.score %>)</span>
        </td>
        <td><%= review.comments %></td>
        <td><%= review.created_at.in_time_zone('Tokyo').strftime('%Y年%m月%d日 %H:%M') %></td>
        <td>
          <% if review.user_id.present? %>
            <span class="badge bg-secondary">無効票（<%= review.user.name %>）</span>
          <% else %>
            <span class="badge bg-success">有効票</span>
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<!-- ページネーション -->
<div class="d-flex justify-content-center">
  <%= paginate @paginated_reviews %>
</div>

<div class="mt-4">
  <%= link_to '店舗情報に戻る', shop_path(@shop), class: 'btn btn-secondary' %>
</div>